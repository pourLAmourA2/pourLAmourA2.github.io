<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Lecteur audio pour Réseau Contact</title>
</head>

<body>
  <h1>Lecteur audio pour Réseau Contact</h1>

  <div style="min-width:400px; width:100%; max-width:892px;">
    <div style="width:100%; margin-bottom:4px;">
      <input type="text" id="photoURL"
        value="Adresse d'une photo sur RC - Par ex.: http://image.reseaucontact.com/v1/dynamic_resize/id/..."
        style="color:#696969; border:0px; border-bottom:1px solid; font-style:italic; padding:4px 0px; width:100%;"
        onfocus="clearURL()" onblur="initURL()" onkeypress="if (event.keyCode == 13) loadRCphoto();">
    </div>

    <div style="width:100%;">
      <div style="float:right; width:256px;">
        <canvas id="mainCanvas" height="525" width="256" style="background-color:#ffbfff;">
          Votre navigateur ne supporte pas les canvas. Désolé!
        </canvas>
      </div>

      <div style="margin-right:260px;">
        <input type="button" id="boLoad"
          value="Charger la photo"
          style="width:100%; height:32px; margin-bottom:4px;"
          onclick="loadPhoto()">

        <div id="audioControls" style="background-color:#A2A2A2; width:100%;">
        </div>
      </div>
    </div>
  </div>
</body>

<script>
function clearURL() {
  var photoURL = document.getElementById("photoURL");
  photoURL.onfocus = function(){ photoURL.select(); };
  photoURL.value = "";
  photoURL.style.fontStyle = "normal";
  photoURL.style.color = "#000000";
}

function initURL() {
  var photoURL = document.getElementById("photoURL");

  if (photoURL.value.length == 0) {
    photoURL.style.color = "#696969";
    photoURL.style.fontStyle = "italic";
    photoURL.value = "Adresse d'une photo sur RC - Par ex.: http://image.reseaucontact.com/v1/dynamic_resize/id/...";
    photoURL.onfocus = clearURL;
  }
}


var mainCanvas = document.getElementById("mainCanvas");
var mainWidth = mainCanvas.width;
var mainHeight = mainCanvas.height;

function loadPhoto() {
  var photoURL = document.getElementById("photoURL").value;
  var reWeb = new RegExp("^http://image.reseaucontact.com/v1/dynamic_resize/id/");
  var reLoc = new RegExp("^file:///");

  if (reWeb.exec(photoURL) || reLoc.exec(photoURL)) {
    photoURL = photoURL.replace(/size=[0-9]+x[0-9]+/gi, "size=700x525");
    photoURL = photoURL.replace(/resize_bigger=[a-z]+/gi, "resize_bigger=false");
    photoURL = photoURL.replace(/quality=[0-9]+/gi, "quality=99");
    photoURL = photoURL.replace(/&clip=[0-9]+/gi, "");
    photoURL = photoURL.replace(/&clip_gravity=[a-z]+/gi, "");

    var encodedImage = new Image();

    encodedImage.onload = function() {
      var mainContex = mainCanvas.getContext('2d');

      if (encodedImage.naturalWidth == mainWidth && encodedImage.naturalHeight == mainHeight) {
        mainContex.drawImage(encodedImage, 0, 0);
      }
      else {
        mainContex.clearRect(0, 0, mainWidth, mainHeight);
        mainContex.fillText("L'image n'a pas une taille de 256x525", 4, 12);
      }
    }

    encodedImage.src = photoURL;
  }
}
</script>
</html>
