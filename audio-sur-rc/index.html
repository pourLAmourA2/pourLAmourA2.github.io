<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Lecteur audio pour Réseau Contact</title>
</head>

<body>
  <h1>Lecteur audio pour Réseau Contact</h1>

  <div style="min-width:400px; width:100%; max-width:892px;">
    <div style="width:100%; margin-bottom:4px;">
      <input type="text" id="photoURL"
        value="Adresse d'une photo sur RC - Par ex.: http://image.reseaucontact.com/v1/dynamic_resize/id/..."
        style="color:#696969; border:0px; border-bottom:1px solid; font-style:italic; padding:4px 0px; width:100%;"
        onfocus="clearURL()" onblur="initURL()" onkeypress="if (event.keyCode == 13) loadURL();">
    </div>

    <div style="width:100%;">
      <div style="float:right; width:256px;">
        <canvas id="mainCanvas" height="525" width="256" style="background-color:#ffbfff;">
          Votre navigateur ne supporte pas les canvas. Désolé!
        </canvas>
      </div>

      <div style="margin-right:260px;">
        <input type="button" id="boLoad"
          value="Charger la photo"
          style="width:100%; height:32px; margin-bottom:4px;"
          onclick="loadURL()" />

        <div id="audioControls" style="width:100%;">
          <input id="boPlay" type="button" value="| > Jouer  /  [  ] Arrêter"
            style="width:100%; height:32px; margin-bottom:4px;"
            onclick="loadURL()" />
        </div>
      </div>
    </div>
  </div>
  <hr />
  <p>Copyright (c) 2015 pourLAmourA2 - <a href="../LICENSE">MIT License</a></p>
</body>

<script src="core.js" type="text/javascript"></script>
<script src="audio.js" type="text/javascript"></script>
<script src="scaler.js" type="text/javascript"></script>
<script src="dct.js" type="text/javascript"></script>
<script src="audixel.js" type="text/javascript"></script>

<script>
var mainCanvas = document.getElementById("mainCanvas");
var mainContex = mainCanvas.getContext('2d');
var mainWidth = mainCanvas.width;
var mainHeight = mainCanvas.height;


var photoURL = document.getElementById("photoURL");

var boLoad = document.getElementById("boLoad");
boLoad.disabled = false;

function clearURL() {
    photoURL.onfocus = function(){ photoURL.select(); };
    photoURL.value = "";
    photoURL.style.fontStyle = "normal";
    photoURL.style.color = "#000000";
}

function initURL() {
    if (photoURL.value.length == 0) {
        photoURL.style.color = "#696969";
        photoURL.style.fontStyle = "italic";
        photoURL.value = "Adresse d'une photo sur RC - Par ex.: http://image.reseaucontact.com/v1/dynamic_resize/id/...";
        photoURL.onfocus = clearURL;
    }
}


function loadURL() {
    var theURL = photoURL.value;
    var reWeb = new RegExp("^http://image.reseaucontact.com/v1/dynamic_resize/id/");
    var reLoc = new RegExp("^file://");
    var reB64 = new RegExp("^data:image/png;base64");

    if (reWeb.exec(theURL) || reLoc.exec(theURL) || reB64.exec(theURL)) {
        if (reWeb.exec(theURL)) {
            theURL = theURL.replace(/size=[0-9]+x[0-9]+/gi, "size=700x525");
            theURL = theURL.replace(/resize_bigger=[a-z]+/gi, "resize_bigger=false");
            theURL = theURL.replace(/quality=[0-9]+/gi, "quality=99");
            theURL = theURL.replace(/&clip=[0-9]+/gi, "");
            theURL = theURL.replace(/&clip_gravity=[a-z]+/gi, "");
        }
        console.log(theURL);

        var encodedImage = new Image();

        encodedImage.onload = function(event) {
            if (encodedImage.naturalWidth == mainWidth && encodedImage.naturalHeight == mainHeight) {
                mainContex.drawImage(this, 0, 0);
                var imageData = mainContex.getImageData(0, mainWidth, mainWidth, mainWidth);
                //var onlyData = imageData.data;
                boPlay.onclick = function() { onStartPlay(boLoad); }
                boPlay.disabled = false;
            }
            else {
                mainContex.clearRect(0, 0, mainWidth, mainHeight);
                mainContex.fillText("L'image n'a pas une taille de 256x525", 4, 12);
                boPlay.disabled = true;
            }
        };

        encodedImage.src = theURL;
    }
    else {
        boPlay.disabled = true;
    }
}
</script>
</html>
